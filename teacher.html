<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>교사 화면</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --line:#334155; --brand:#1d4ed8; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;margin:0;background:var(--bg);color:#fff}
    header{background:var(--brand);padding:12px 16px;display:flex;align-items:center;gap:10px}
    .pill{display:inline-block;background:#172554;border:1px solid #334155;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    button{padding:10px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .primary{background:var(--ok);color:#052814}
    .ghost{background:#374151;color:#fff}
    .warn{background:var(--warn);color:#1f1300}
    .danger{background:var(--danger);color:#2b0b0b}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;background:#0b1220;border:1px solid var(--line);padding:4px 6px;border-radius:8px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    input,select,textarea{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#fff}
    textarea{width:100%;min-height:80px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:14px}
    small{color:var(--muted)}
    .grow{flex:1}
  </style>
</head>
<body>
  <header>
    <div>교사 화면</div>
    <div id="user" class="pill">로그인 확인 중...</div>
  </header>

  <main>
    <!-- 상단 컨트롤 (개별진행 전제: Prev/Next/자동진행 제거) -->
    <div class="row">
      <button id="btnCreate" class="primary">게임 만들기</button>
      <button id="btnStart"  class="warn"   disabled>시작</button>
      <button id="btnReset"  class="ghost"  disabled>초기화(대기)</button>
      <button id="btnEnd"    class="danger" disabled>종료</button>
      <span class="pill">모드: 개별진행(SELF-PACED)</span>

      <button id="btnSignOut" class="ghost">로그아웃</button>
      <a href="./teacher-login.html" class="pill" style="text-decoration:none;">로그인 화면으로</a>
    </div>

    <!-- 게임 상태 -->
    <div class="row card" id="gameInfo" style="display:none;align-items:center;gap:12px;">
      <div>게임 ID: <span id="gid" class="kbd"></span></div>
      <button id="btnCopy" class="ghost">ID 복사</button>
      <div class="pill">학생: /question/join.html</div>
      <div class="pill">상태: <span id="gstatus">-</span></div>
      <div class="pill">총 문항: <span id="gtotal">0</span></div>
      <div class="pill">온라인: <span id="gonline">0</span></div>
      <div class="pill">완료: <span id="gfinished">0</span></div>
    </div>

    <!-- 템플릿 관리 / 불러오기 -->
    <section class="card" id="templateBox" style="display:none;">
      <h3 style="margin:0 0 8px;">문제 세트(템플릿) 관리 & 불러오기</h3>
      <div class="row">
        <select id="tplSelect" class="grow"></select>
        <button id="btnTplUse" class="ghost">선택 불러오기</button>
        <button id="btnTplDel" class="danger">선택 삭제</button>
        <span id="tplInfo" class="pill">미리보기: -문항</span>
      </div>
      <div class="row">
        <input id="tplId" class="grow" placeholder="원본 게임 ID (예: KOR-SET-1 혹은 자동 생성 ID)" />
        <input id="tplTitle" class="grow" placeholder="표시 이름 (예: 6학년 국어 세트 1)" />
        <button id="btnTplAdd" class="primary">템플릿 추가(저장)</button>
        <button id="btnTplImport" class="ghost">ID로 불러오기</button>
      </div>
      <small>Tips) 템플릿은 <b>브라우저 로컬 저장소</b>에 저장됩니다. 여러 세트를 만들어 두고 필요할 때 불러오세요.</small>
    </section>

    <!-- 문제 에디터 -->
    <section id="editor" class="card" style="display:none;">
      <h3 style="margin:0 0 8px;">문제 추가</h3>
      <div class="row">
        <label>유형
          <select id="qtype">
            <option value="mcq">객관식</option>
            <option value="short">주관식</option>
          </select>
        </label>
        <label>보기 개수(객관식)
          <select id="qcount">
            <option>2</option><option selected>4</option><option>5</option>
          </select>
        </label>
      </div>
      <div class="row">
        <textarea id="qprompt" placeholder="문제 내용을 입력하세요"></textarea>
      </div>
      <div id="choices" class="row" style="flex-direction:column;width:100%;"></div>
      <div class="row">
        <label>정답
          <input id="qanswer" placeholder="객관식: A/B/C..., 주관식: 정답 문자열" />
        </label>
        <button id="btnAdd" class="primary">문제 추가</button>
      </div>
      <small>객관식 정답 표기는 A/B/C/D/E 중 하나로 입력하면 편합니다.</small>
    </section>

    <!-- 문제 목록 -->
    <section id="list" class="card" style="display:none;">
      <h3 style="margin:0 0 8px;">문제 목록</h3>
      <table>
        <thead><tr><th style="width:60px;">#</th><th>유형</th><th>문제</th><th>정답</th><th style="width:120px;">관리</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <!-- 결과 요약(점수판 + 정답률) -->
    <section id="scoreboard" class="card" style="display:none;">
      <h3 style="margin:0 0 8px;">결과 요약</h3>

      <h4 style="margin-top:14px">참가자 점수</h4>
      <table>
        <thead><tr><th style="width:60px">순위</th><th>이름</th><th style="width:120px">점수</th></tr></thead>
        <tbody id="tbPlayers"></tbody>
      </table>

      <h4 style="margin-top:14px">문항별 정답률</h4>
      <table>
        <thead><tr><th style="width:80px">문항</th><th style="width:160px">정답/제출</th><th>정답률</th></tr></thead>
        <tbody id="tbQstats"></tbody>
      </table>
    </section>

    <p style="margin-top:16px;"><small>흐름) “게임 만들기” → (필요 시 템플릿 불러오기) → 시작 → 각자 진행 → 종료</small></p>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="./js/firebase-init.js"></script>

  <script>
    /* ───────── 로그인 가드 ───────── */
    auth.onAuthStateChanged(user => {
      const $u = document.getElementById('user');
      if (!user) { $u.textContent='로그인이 필요합니다'; location.replace('./teacher-login.html'); return; }
      $u.textContent = `로그인: ${user.displayName || user.email}`;
    });

    /* ───────── 유틸 ───────── */
    const $ = s => document.querySelector(s);
    function genId(len=7){ const C='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<len;i++) s+=C[Math.floor(Math.random()*C.length)]; return s; }

    let gameId = localStorage.getItem('q_gameId') || '';
    let unsubGame=null, unsubList=null;
    let unsubPresence=null, unsubNames=null, unsubResp=null; // 구독 분리(충돌 방지)

    /* ───────── 템플릿(로컬 저장) ───────── */
    const TPL_KEY = 'q_templates_v1';
    function loadTpls(){ try { return JSON.parse(localStorage.getItem(TPL_KEY)||'[]'); } catch(_) { return []; } }
    function saveTpls(arr){ localStorage.setItem(TPL_KEY, JSON.stringify(arr)); renderTpls(); }
    async function previewTplCount(id){
      try{ const snap = await db.collection('q_games').doc(id).collection('q_questions').get(); return snap.size; }
      catch{ return null; }
    }
    async function renderTpls(){
      const sel = $('#tplSelect'); sel.innerHTML='';
      const tpls = loadTpls();
      if (tpls.length===0) {
        const opt = document.createElement('option'); opt.textContent='(저장된 템플릿 없음)'; opt.value='';
        sel.appendChild(opt); $('#tplInfo').textContent = '미리보기: -문항'; return;
      }
      tpls.forEach(t=>{
        const opt = document.createElement('option'); opt.value = t.id; opt.textContent = `${t.title}  (${t.id})`;
        sel.appendChild(opt);
      });
      sel.onchange = async ()=>{
        const id = sel.value;
        if (!id) { $('#tplInfo').textContent='미리보기: -문항'; return; }
        const n = await previewTplCount(id);
        $('#tplInfo').textContent = `미리보기: ${n ?? '?' }문항`;
      };
      sel.dispatchEvent(new Event('change'));
    }

    async function copyQuestions(srcId, destId) {
      if (!srcId) throw new Error('원본 게임 ID가 없습니다.');
      if (srcId === destId) throw new Error('같은 게임으로는 복사할 수 없습니다.');

      const srcQ = db.collection('q_games').doc(srcId).collection('q_questions').orderBy('order','asc');
      const dstQ = db.collection('q_games').doc(destId).collection('q_questions');

      // 1) 현재 문제들 삭제
      const exist = await dstQ.get();
      if (!exist.empty) {
        let b = db.batch(); let n=0;
        exist.forEach(d=>{ b.delete(dstQ.doc(d.id)); n++; if(n%400===0){ b.commit(); b=db.batch(); } });
        await b.commit();
      }

      // 2) 복사
      const snap = await srcQ.get();
      let b = db.batch(), i=0;
      snap.forEach(doc=>{
        const q=doc.data();
        b.set(dstQ.doc(), {
          type:q.type, prompt:q.prompt, choices:q.choices||null, answer:q.answer,
          order: (typeof q.order==='number'? q.order : i)
        });
        i++; if(i%400===0){ b.commit(); b=db.batch(); }
      });
      await b.commit();

      // 3) 총 문항/상태 초기화 (selfPaced 유지)
      await db.collection('q_games').doc(destId).set({
        totalQuestions: snap.size, status:'waiting', currentIndex:-1, questionStartAt: null, selfPaced:true
      }, {merge:true});

      return snap.size;
    }

    /* ───────── 지난 응답/점수 정리 ───────── */
    async function clearResponses(gameId){
      try{
        const col = db.collection('q_games').doc(gameId).collection('q_responses');
        const snap = await col.get();
        if (snap.empty) return;
        let batch = db.batch(), n=0;
        snap.forEach(doc=>{
          batch.delete(col.doc(doc.id));
          n++; if (n%400===0){ batch.commit(); batch = db.batch(); }
        });
        await batch.commit();
      }catch(e){ console.warn('응답 정리 실패(무시):', e?.message||e); }
    }

    async function resetPlayerScores(gameId){
      try{
        const col = db.collection('q_games').doc(gameId).collection('q_players');
        const snap = await col.get();
        if (snap.empty) return;
        let batch = db.batch(), n=0;
        snap.forEach(doc=>{
          batch.set(col.doc(doc.id), { scoreTotal: 0, progressIndex: 0, finished:false }, { merge:true });
          n++; if (n%400===0){ batch.commit(); batch = db.batch(); }
        });
        await batch.commit();
      }catch(e){ console.warn('점수/진행도 초기화 실패(무시):', e?.message||e); }
    }

    /* ───────── 플레이어 상태(온라인/완료) 카운트 ───────── */
    function bindPlayerPresence(){
      if (unsubPresence) unsubPresence();
      const cutoffMs = 40000; // 40초 내 하트비트면 온라인
      unsubPresence = db.collection('q_games').doc(gameId)
        .collection('q_players')
        .onSnapshot(s=>{
          let online=0, finished=0;
          const now = Date.now();
          s.forEach(d=>{
            const p = d.data() || {};
            const last = p.lastSeenAt?.toMillis?.() ?? 0;
            if (p.active === true || (last && (now-last) < cutoffMs)) online++;
            if (p.finished === true) finished++;
          });
          $('#gonline').textContent = String(online);
          $('#gfinished').textContent = String(finished);
        });
    }

    /* ───────── 점수판 바인딩 ───────── */
    function bindScoreboard(){
      if (!gameId) return;
      $('#scoreboard').style.display='block';

      const gref = db.collection('q_games').doc(gameId);

      // 참가자 이름 맵
      const names = {};
      if (unsubNames) unsubNames();
      unsubNames = db.collection('q_games').doc(gameId)
        .collection('q_players')
        .onSnapshot(snap=>{
          snap.forEach(d=>{
            const p = d.data();
            names[p.pid || d.id] = p.name || '(이름)';
          });
        });

      // 응답 합산(개별진행: 전체 응답 누적)
      if (unsubResp) unsubResp();
      unsubResp = db.collection('q_games').doc(gameId)
        .collection('q_responses')
        .onSnapshot(async snap=>{
          const byPlayer = {};
          const byOrder  = {};

          snap.forEach(doc=>{
            const r = doc.data();
            if (!byPlayer[r.playerId]) byPlayer[r.playerId] = 0;
            byPlayer[r.playerId] += (r.score || 0);

            const o = r.order|0;
            if (!byOrder[o]) byOrder[o] = {total:0, correct:0};
            byOrder[o].total++;
            if (r.isCorrect) byOrder[o].correct++;
          });

          // 참가자 점수
          const rows = Object.entries(byPlayer)
            .map(([pid,score])=>({pid, name:names[pid] || '(이름)', score}))
            .sort((a,b)=> b.score - a.score);

          const $p = $('#tbPlayers'); $p.innerHTML='';
          rows.forEach((row,i)=>{
            const tr=document.createElement('tr');
            tr.innerHTML = `<td>${i+1}</td><td>${row.name}</td><td>${row.score}</td>`;
            $p.appendChild(tr);
          });

          // 문항별 정답률(빈 문항도 0으로 채움)
          const g = (await gref.get()).data() || {};
          const totalQ = g.totalQuestions || 0;
          const $q = $('#tbQstats'); $q.innerHTML='';
          for(let i=0;i<totalQ;i++){
            const st = byOrder[i] || {total:0, correct:0};
            const rate = st.total ? Math.round(st.correct*100/st.total) : 0;
            const tr=document.createElement('tr');
            tr.innerHTML = `<td>${i+1}</td><td>${st.correct} / ${st.total}</td><td>${rate}%</td>`;
            $q.appendChild(tr);
          }
        });
    }

    /* ───────── 게임 UI 바인딩 ───────── */
    function ensureUI(){
      if (!gameId) return;
      $('#gid').textContent = gameId;
      $('#gameInfo').style.display='flex';
      $('#templateBox').style.display='block';
      $('#editor').style.display='block';
      $('#list').style.display='block';
      $('#scoreboard').style.display='block';
      bindScoreboard();
      bindPlayerPresence();

      if (unsubGame) unsubGame();
      unsubGame = db.collection('q_games').doc(gameId).onSnapshot(s=>{
        if(!s.exists) return;
        const g=s.data();
        const total = g.totalQuestions || 0;

        $('#gstatus').textContent = g.status;
        $('#gtotal').textContent  = total;

        // 버튼 상태
        $('#btnStart').disabled = !(g.status==='waiting' && total>0);
        $('#btnEnd').disabled   = !(g.status==='running');
        $('#btnReset').disabled = (g.status==='waiting');
      });

      if (unsubList) unsubList();
      unsubList = db.collection('q_games').doc(gameId).collection('q_questions')
        .orderBy('order','asc').onSnapshot(sn=>{
          const tbody=$('#tbody'); tbody.innerHTML='';
          sn.forEach(doc=>{
            const q=doc.data();
            const tr=document.createElement('tr');
            tr.innerHTML=`
              <td>${q.order}</td>
              <td>${q.type}</td>
              <td style="max-width:600px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${q.prompt}</td>
              <td>${q.answer}</td>
              <td><button class="ghost" data-del="${doc.id}">삭제</button></td>`;
            tbody.appendChild(tr);
          });
          db.collection('q_games').doc(gameId).set({ totalQuestions: sn.size }, {merge:true});
          tbody.onclick = async (e)=>{
            const id=e.target.getAttribute?.('data-del'); if(!id) return;
            if(!confirm('정말 삭제할까요?')) return;
            await db.collection('q_games').doc(gameId).collection('q_questions').doc(id).delete();
          };
        });
    }

    /* ───────── 상단 버튼 ───────── */
    $('#btnCreate').addEventListener('click', async ()=>{
      const user=auth.currentUser; if(!user) return alert('로그인이 필요합니다');
      gameId = genId(7);
      const gameDoc = {
        title: `퀴즈 - ${new Date().toLocaleString()}`,
        status:'waiting', createdBy:user.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        currentIndex:-1, totalQuestions:0,
        selfPaced:true,                    // 기본값: 개별진행
        questionStartAt: null
      };
      await db.collection('q_games').doc(gameId).set(gameDoc,{merge:true});
      localStorage.setItem('q_gameId', gameId);
      ensureUI();
      alert('게임이 생성되었습니다. 학생에게 게임 ID를 전달하세요.');
    });

    $('#btnCopy').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(gameId); alert('게임 ID 복사됨'); }catch{ alert('복사 실패'); } });
    $('#btnSignOut').addEventListener('click', async ()=>{ await auth.signOut(); location.replace('./teacher-login.html'); });

    // 시작: 응답 제거 + 모든 참가자 진행도 0/미완료로 초기화 (점수는 유지)
    $('#btnStart').addEventListener('click', async ()=>{
      if(!gameId) return;
      const gref = db.collection('q_games').doc(gameId);
      await clearResponses(gameId);

      // 진행도 초기화(현재 존재하는 플레이어들)
      try{
        const col = db.collection('q_games').doc(gameId).collection('q_players');
        const snap = await col.get();
        let b = db.batch(), n=0;
        snap.forEach(d=>{
          b.set(col.doc(d.id), { progressIndex: 0, finished:false }, { merge:true });
          n++; if(n%400===0){ b.commit(); b=db.batch(); }
        });
        await b.commit();
      }catch(e){ console.warn('플레이어 진행도 초기화 실패(무시):', e?.message||e); }

      await gref.set({
        status:'running',
        selfPaced:true,
        currentIndex:-1,                  // 동기진행 X
        questionStartAt: null
      }, {merge:true});
    });

    // 초기화(대기): 응답 비움 + 점수/진행도 리셋 + 상태 대기
    $('#btnReset').addEventListener('click', async ()=>{
      if(!confirm('게임을 대기 상태로 초기화할까요? (현재 진행 상황과 응답이 초기화됩니다)')) return;
      await clearResponses(gameId);
      await resetPlayerScores(gameId); // scoreTotal/진행도/완료 리셋
      await db.collection('q_games').doc(gameId).set({
        status:'waiting', currentIndex:-1, questionStartAt: null, selfPaced:true
      }, {merge:true});
    });

    $('#btnEnd').addEventListener('click', async ()=>{
      await db.collection('q_games').doc(gameId).set({ status:'ended' }, {merge:true});
    });

    /* ───────── 문제 에디터 ───────── */
    const $choices = () => [...document.querySelectorAll('[data-chidx]')];
    function renderChoiceInputs(n=4){
      const wrap=document.querySelector('#choices'); wrap.innerHTML='';
      for(let i=0;i<n;i++){
        const L=String.fromCharCode(65+i);
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<label style="width:100%">보기 ${L} <input data-chidx="${i}" style="width:100%" placeholder="보기 내용을 입력하세요"></label>`;
        wrap.appendChild(row);
      }
    }
    renderChoiceInputs(4);
    document.getElementById('qcount').addEventListener('change', e=> renderChoiceInputs(Number(e.target.value)));
    document.getElementById('qtype').addEventListener('change', e=>{
      const type=e.target.value;
      document.getElementById('qcount').disabled = (type!=='mcq');
      document.getElementById('choices').style.display = (type==='mcq') ? 'block' : 'none';
    });
    document.getElementById('btnAdd').addEventListener('click', async ()=>{
      if(!gameId) return alert('먼저 게임을 만드세요.');
      const type=document.getElementById('qtype').value,
            prompt=document.getElementById('qprompt').value.trim(),
            answer=document.getElementById('qanswer').value.trim();
      if(!prompt || !answer) return alert('문제와 정답을 입력하세요.');
      let choices=null;
      if(type==='mcq'){
        choices = $choices().map(i=>i.value.trim()).filter(v=>v!=='');
        if(choices.length<2) return alert('객관식은 최소 2개의 보기 필요');
      }
      const listSnap = await db.collection('q_games').doc(gameId).collection('q_questions').get();
      const order=listSnap.size;
      await db.collection('q_games').doc(gameId).collection('q_questions').add({
        type,prompt,choices,answer,order, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById('qprompt').value='';
      document.getElementById('qanswer').value='';
      $choices().forEach(i=>i.value='');
    });

    /* ───────── 템플릿 UI/행동 ───────── */
    document.getElementById('btnTplAdd').addEventListener('click', ()=>{
      const id=document.getElementById('tplId').value.trim();
      const title=document.getElementById('tplTitle').value.trim();
      if(!id || !title){ alert('ID와 표시 이름을 입력하세요.'); return; }
      const list=loadTpls();
      if(list.some(t=>t.id===id)){ alert('이미 저장된 ID입니다.'); return; }
      list.push({id, title}); saveTpls(list);
      document.getElementById('tplId').value=''; document.getElementById('tplTitle').value='';
    });
    document.getElementById('btnTplDel').addEventListener('click', ()=>{
      const id=document.getElementById('tplSelect').value; if(!id){ alert('삭제할 템플릿을 선택하세요.'); return; }
      const list=loadTpls().filter(t=>t.id!==id); saveTpls(list);
    });
    document.getElementById('btnTplUse').addEventListener('click', async ()=>{
      const id=document.getElementById('tplSelect').value; if(!id){ alert('템플릿을 선택하세요.'); return; }
      if(!gameId){ alert('먼저 게임을 만드세요.'); return; }
      if(!confirm('현재 게임의 문제를 모두 지우고 템플릿에서 복사합니다. 계속할까요?')) return;
      try{
        const n = await copyQuestions(id, gameId);
        alert(`복사 완료! (${n}문항)`);
      }catch(e){ alert('복사 실패: '+e.message); console.error(e); }
    });
    document.getElementById('btnTplImport').addEventListener('click', async ()=>{
      const id=document.getElementById('tplId').value.trim(); if(!id){ alert('원본 게임 ID를 입력하세요.'); return; }
      if(!gameId){ alert('먼저 게임을 만드세요.'); return; }
      if(!confirm('현재 게임의 문제를 모두 지우고 복사합니다. 계속할까요?')) return;
      try{
        const n = await copyQuestions(id, gameId);
        alert(`복사 완료! (${n}문항)`);
      }catch(e){ alert('복사 실패: '+e.message); console.error(e); }
    });
    document.getElementById('tplSelect').addEventListener('change', async ()=>{
      const id=document.getElementById('tplSelect').value; if(!id){ document.getElementById('tplInfo').textContent='미리보기: -문항'; return; }
      const n = await previewTplCount(id); document.getElementById('tplInfo').textContent = `미리보기: ${n ?? '?' }문항`;
    });

    // 초기 바인딩
    renderTpls();
    if (gameId) ensureUI();
  </script>
</body>
</html>
