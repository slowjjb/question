<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê²Œì„ í™”ë©´</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--line:#334155;--muted:#94a3b8;--brand:#1d4ed8;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
    .wrap{max-width:860px;margin:24px auto;padding:0 16px}
    .card{background:#111827;border:1px solid var(--line);border-radius:16px;padding:20px}
    .center{display:grid;place-items:center;min-height:40vh;text-align:center}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;background:#172554;border:1px solid #334155;border-radius:999px;padding:6px 10px;font-weight:700}
    .kbd{font-family:ui-monospace,monospace;background:#0b1220;border:1px solid #334155;padding:4px 6px;border-radius:8px}
    button{padding:11px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .primary{background:var(--ok);color:#052814}
    .ghost{background:#374151;color:#fff}
    .danger{background:#ef4444;color:#2b0b0b}
    .muted{color:#94a3b8}
    .qbox{margin-top:12px;padding:14px;border:1px solid var(--line);border-radius:12px;background:#0b1220}
    .choice{display:block;padding:12px 14px;border:1px solid #334155;border-radius:12px;margin-top:8px;cursor:pointer}
    .choice.active{outline:3px solid #60a5fa;border-color:#60a5fa;background:#0b1930}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:#fff}
    h1{font-size:22px;margin:0 0 6px}
    h2{font-size:18px;margin:0 0 10px}
  </style>
</head>
<body>
<div class="wrap">

  <!-- ìƒë‹¨ ë°” -->
  <div class="row" style="justify-content:space-between;margin-bottom:10px">
    <div class="pill">ê²Œì„ í™”ë©´</div>
    <div class="row">
      <div class="pill">ê²Œì„ ID: <span id="gid" class="kbd">-</span></div>
      <div class="pill">ìƒíƒœ: <span id="gstatus">-</span></div>
      <div class="pill">ë¬¸í•­: <span id="gindex">-</span></div>
    </div>
  </div>

  <!-- ëŒ€ê¸°/ì¢…ë£Œ -->
  <div id="view-wait" class="card center" style="display:none">
    <div id="wait-text">ëŒ€ê¸° ì¤‘â€¦ (êµì‚¬ê°€ ì‹œì‘í•˜ë©´ ë¬¸ì œ í™”ë©´ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤)</div>
    <div style="margin-top:10px">ê²Œì„ ID: <span id="gid2" class="kbd"></span></div>
  </div>

  <!-- ë¬¸ì œ -->
  <div id="view-q" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h1 id="q-title">ë¬¸ì œ</h1>
      <div class="row">
        <div class="pill">ê²½ê³¼ <span id="tm">0.0</span>s</div>
        <div class="pill">ê°ì  <span id="pen">0</span></div>
      </div>
    </div>

    <div class="qbox">
      <h2 id="q-prompt"></h2>
      <div id="q-choices" style="margin-top:8px"></div>
      <div id="q-short" style="margin-top:8px;display:none">
        <input id="short-input" type="text" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" />
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="btnSubmit" class="primary">ì œì¶œ</button>
      <button id="btnNext" class="ghost" style="display:none">ë‹¤ìŒìœ¼ë¡œ</button>
    </div>
    <div id="after-msg" class="muted" style="margin-top:8px;display:none"></div>
  </div>

  <!-- ì¢…ë£Œ -->
  <div id="view-end" class="card center" style="display:none">
    <div>ë¬¸ì œë¥¼ ëª¨ë‘ í’€ì—ˆìŠµë‹ˆë‹¤! ğŸ‘</div>
    <div style="margin-top:10px">ê²Œì„ ID: <span id="gid3" class="kbd"></span></div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="./js/firebase-init.js"></script>
<script>
  // â”€â”€ helpers
  const $=s=>document.querySelector(s);
  function getQuery(k){const u=new URL(location.href);return u.searchParams.get(k)}
  const gameId = getQuery('game') || localStorage.getItem('q_gameId') || '';
  $('#gid').textContent = $('#gid2').textContent = $('#gid3').textContent = gameId || '(ì—†ìŒ)';

  const playersCol = ()=>db.collection('q_games').doc(gameId).collection('q_players');
  const questionsCol = ()=>db.collection('q_games').doc(gameId).collection('q_questions');
  const responsesCol = ()=>db.collection('q_games').doc(gameId).collection('q_responses');
  const gameDoc      = ()=>db.collection('q_games').doc(gameId);

  function show(id){
    for(const v of ['#view-wait','#view-q','#view-end']) $(v).style.display='none';
    $(id).style.display='block';
  }

  // ì ìˆ˜ ê·œì¹™(ì •ë‹µì¼ ë•Œë§Œ): 10ì´ˆë¶€í„° 10ì´ˆë§ˆë‹¤ -1, ìµœëŒ€ -5
  function calcScore(isCorrect, elapsedSec){
    if(!isCorrect) return {score:0,penalty:0};
    const over = Math.max(0, elapsedSec - 10);
    let penalty = Math.ceil(over/10);
    penalty = Math.min(5, penalty);
    const score = Math.max(0, 10 - penalty);
    return {score,penalty};
  }

  // â”€â”€ ìƒíƒœ
  let ME=null, playerDoc=null, hb=null;
  let unsubGame=null, unsubMe=null, timer=null, submitted=false;
  let totalQ=0, myIndex=0, myIndexLocal=0, meFinished=false, renderedIndex=-1;

  let lastGameStatus = '';
  let allowServerDecrease = false;
  let isRunning = false; // â˜… ë³€ê²½: running ìƒíƒœ í”Œë˜ê·¸

  const TIMEOUT_SEC = 50;      // 50ì´ˆ ìë™ì œì¶œ
  const AUTO_ADVANCE_MS = 0;   // ìë™ë„˜ê¹€ ë¹„í™œì„±(â€œë‹¤ìŒìœ¼ë¡œâ€ ëˆŒëŸ¬ ì´ë™)

  // â”€â”€ presence heartbeat
  async function startHeartbeat(){
    const push = () => playerDoc.set({
      active:true, lastSeenAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    try{
      await push();
      hb = setInterval(push, 15000);
      document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) push(); });
      window.addEventListener('beforeunload', ()=>{
        try{ playerDoc.set({ active:false, lastSeenAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true}); }catch(_){}
        if(hb){ clearInterval(hb); hb=null; }
      });
    }catch(_){}
  }

  // â”€â”€ auth
  auth.onAuthStateChanged(async (u)=>{
    try{
      if(!u) u = (await auth.signInAnonymously()).user;
      ME = u;

      const pRef = playersCol().doc(ME.uid);
      const pSnap = await pRef.get();
      if(!pSnap.exists){
        await pRef.set({
          pid: ME.uid,
          name:  localStorage.getItem('q_name')  || 'í•™ìƒ',
          klass: localStorage.getItem('q_class') || '',
          number:localStorage.getItem('q_no')    || '',
          scoreTotal: 0,
          progressIndex: 0,
          finished: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastSeenAt: firebase.firestore.FieldValue.serverTimestamp(),
          active: true
        }, {merge:true});
      }else{
        const d = pSnap.data()||{};
        myIndexLocal = Number(d.progressIndex||0);
        meFinished = !!d.finished;
      }
      playerDoc = pRef;

      startHeartbeat();
      bindGame();
      bindMe();
    }catch(e){
      alert('ë¡œê·¸ì¸ ì˜¤ë¥˜: '+e.message);
    }
  });

  // â”€â”€ ë‚´ ì§„í–‰ë„/ì™„ë£Œ ë°”ì¸ë”©
  function bindMe(){
    if(unsubMe) unsubMe();
    unsubMe = playerDoc.onSnapshot(s=>{
      const d = s.data() || {};

      if (!meFinished && d.finished === true) meFinished = true;

      const serverIdx = Number(d.progressIndex || 0);
      if (allowServerDecrease){
        myIndexLocal = serverIdx;
        allowServerDecrease = false;
      } else if (serverIdx >= myIndexLocal) {
        myIndexLocal = serverIdx;
      } else {
        console.warn('ì„œë²„ ì§„í–‰ë„ ê°ì†Œ ê°ì§€ â†’ ë¬´ì‹œ:', serverIdx, 'ìœ ì§€:', myIndexLocal);
      }
      myIndex = myIndexLocal;

      if (totalQ>0) $('#gindex').textContent = `${Math.min(myIndex+1,totalQ)}/${totalQ}`;
      else $('#gindex').textContent = `${myIndex+1}/?`;

      if(meFinished){ show('#view-end'); stopTimer(); return; }

      // â˜… ë³€ê²½: running ìƒíƒœì—ì„œë§Œ ë¬¸ì œ ë Œë”
      if (isRunning && (renderedIndex !== myIndex)){
        renderQuestion(myIndex);
      }
    });
  }

  // â”€â”€ game binding
  function bindGame(){
    if(!gameId){ $('#wait-text').textContent='ê²Œì„ ID ì—†ìŒ: join í™”ë©´ì—ì„œ ë‹¤ì‹œ ì…ì¥í•´ ì£¼ì„¸ìš”.'; show('#view-wait'); return; }

    if(unsubGame) unsubGame();
    unsubGame = gameDoc().onSnapshot(async (snap)=>{
      if(!snap.exists){ $('#wait-text').textContent='ê²Œì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; show('#view-wait'); return; }

      const g=snap.data();
      const status = g.status || '-';
      $('#gstatus').textContent = status;

      isRunning = (status === 'running'); // â˜… ë³€ê²½: ìƒíƒœ í”Œë˜ê·¸ ê°±ì‹ 

      totalQ = Number(g.totalQuestions || 0);
      if (totalQ>0) $('#gindex').textContent = `${Math.min(myIndex+1,totalQ)}/${totalQ}`;
      else $('#gindex').textContent=`${myIndex+1}/?`;

      if (status !== lastGameStatus){
        if (status === 'waiting'){
          allowServerDecrease = true;
          meFinished = false;
          renderedIndex = -1;
          show('#view-wait'); stopTimer();
        } else if (status === 'running' && lastGameStatus === 'waiting'){
          allowServerDecrease = true;
        }
        lastGameStatus = status;
      }

      if(status==='waiting'){ show('#view-wait'); stopTimer(); return; }
      if(status==='ended'){ show('#view-end'); stopTimer(); return; }

      if(!meFinished){
        // â˜… ë³€ê²½: runningì¼ ë•Œë§Œ ë Œë” ì‹œë„
        if (isRunning && renderedIndex !== myIndex) renderQuestion(myIndex);
      }
    });
  }

  // â”€â”€ ë¬¸ì œ í‘œì‹œ
  let currentQ=null, currentQid=null;
  async function renderQuestion(order){
    try{
      // â˜… ë³€ê²½: ì•ˆì „ ê°€ë“œ â€” running ì•„ë‹ ë•ŒëŠ” ê°•ì œë¡œ ëŒ€ê¸°ë¡œ
      if (!isRunning) { show('#view-wait'); return; }

      if (order < 0) order = 0;

      if (totalQ > 0 && order >= totalQ){
        await playerDoc.set({ finished:true }, {merge:true});
        meFinished = true;
        show('#view-end'); stopTimer(); return;
      }

      stopTimer();
      submitted=false;
      $('#after-msg').style.display='none';
      $('#btnNext').style.display='none';
      $('#btnNext').disabled = true; // ë‹¤ìŒ ë²„íŠ¼ ê¸°ë³¸ ë¹„í™œì„±í™”

      const qSnap = await questionsCol().where('order','==', Number(order)).limit(1).get();
      if(qSnap.empty){
        // ë¡œë”© ì§€ì—° ì‹œ ëŒ€ê¸° í™”ë©´ë§Œ ë³´ì—¬ì£¼ê³  ì¢…ë£Œ ê¸ˆì§€
        show('#view-wait');
        return;
      }
      const qDoc = qSnap.docs[0];
      const q = qDoc.data();
      currentQ = q;
      currentQid = qDoc.id;
      renderedIndex = order;

      $('#q-title').textContent = `ë¬¸ì œ ${order+1}`;
      $('#q-prompt').textContent = q.prompt || '';

      const box = $('#q-choices'); box.innerHTML='';
      document.querySelectorAll('.choice').forEach(x=>x.classList.remove('active'));
      $('#q-short').style.display='none';
      $('#short-input').value='';

      if((q.type||'mcq')==='mcq'){
        const ch = Array.isArray(q.choices) ? q.choices : [];
        ch.forEach((t,i)=>{
          const label = String.fromCharCode(65+i);
          const div = document.createElement('div');
          div.className='choice';
          div.dataset.val = label;
          div.innerHTML = `<b>${label}.</b> ${t||''}`;
          div.onclick = ()=>{
            document.querySelectorAll('.choice').forEach(x=>x.classList.remove('active'));
            div.classList.add('active');
          };
          box.appendChild(div);
        });
      }else{
        $('#q-short').style.display='block';
      }

      $('#short-input').onkeydown = (e)=>{ if(e.key==='Enter'){ e.preventDefault(); doSubmit(false); } };

      show('#view-q');
      startTimer();
    }catch(e){
      alert('ë¬¸ì œ í‘œì‹œ ì˜¤ë¥˜: '+e.message);
    }
  }

  function startTimer(){
    stopTimer();
    const startMs = Date.now();
    timer = setInterval(()=>{
      const sec = Math.max(0, (Date.now()-startMs)/1000);
      $('#tm').textContent = sec.toFixed(1);
      const pen = Math.min(5, Math.max(0, Math.ceil((sec-10)/10)));
      $('#pen').textContent = pen;
      if(!submitted && sec >= TIMEOUT_SEC){
        doSubmit(true);
      }
    }, 200);
  }
  function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }

  // ì œì¶œ
  $('#btnSubmit').addEventListener('click', ()=> doSubmit(false));
  $('#btnNext').addEventListener('click', ()=>{
    if (meFinished) return;
    // ìµœì†Œ ì§€ì—° í›„ í™œì„±í™”ë˜ë¯€ë¡œ ì—¬ê¸°ì„  ê·¸ëŒ€ë¡œ ë Œë”
    renderQuestion(myIndexLocal);
  });

  async function doSubmit(timeout){
    if(submitted || !currentQ) return;
    submitted = true;

    const elapsedSec = Number($('#tm').textContent) ? Math.floor(parseFloat($('#tm').textContent)) : 0;

    let myAnswer='', isCorrect=false;
    if(timeout){
      myAnswer = '(ì‹œê°„ì´ˆê³¼)'; isCorrect = false;
    }else if((currentQ.type||'mcq')==='mcq'){
      const act = document.querySelector('.choice.active');
      if(!act){ alert('ë³´ê¸°ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.'); submitted=false; return; }
      myAnswer = act.dataset.val;
      isCorrect = (String(myAnswer).toUpperCase() === String(currentQ.answer||'').trim().toUpperCase());
    }else{
      myAnswer = ($('#short-input').value||'').trim();
      if(!myAnswer){ alert('ì •ë‹µì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); submitted=false; return; }
      const norm = s=>s.trim().replace(/\s+/g,' ');
      isCorrect = (norm(myAnswer).toLowerCase() === norm(String(currentQ.answer||'')).toLowerCase());
    }

    const {score, penalty} = timeout ? {score:0,penalty:5} : calcScore(isCorrect, elapsedSec);

    const msg = timeout
      ? `â± ì‹œê°„ì´ˆê³¼ì…ë‹ˆë‹¤. (ê²½ê³¼ ${elapsedSec}s)`
      : (isCorrect ? `âœ… ì •ë‹µ! ê²½ê³¼ ${elapsedSec}s, ê°ì  ${penalty}, ì ìˆ˜ ${score}ì `
                   : `âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. (ê²½ê³¼ ${elapsedSec}s)`);
    $('#after-msg').textContent = msg;
    $('#after-msg').style.display='block';

    // ğŸ” ë³´ì•ˆê·œì¹™ê³¼ ì¼ì¹˜: ridëŠ” "UID_ë¬¸í•­ë²ˆí˜¸" ê³ ì •
    const rid = `${ME.uid}_${Number(renderedIndex)}`;
    const nowTs = firebase.firestore.FieldValue.serverTimestamp();

    try{
      await db.runTransaction(async (tr)=>{
        const respRef = responsesCol().doc(rid);

        // Transactionì—ëŠ” create() ì—†ìŒ â†’ ì¡´ì¬ í™•ì¸ í›„ set()
        const existed = await tr.get(respRef);
        if (existed.exists) throw new Error('already-exists');

        tr.set(respRef, {
          rid, gameId, order: Number(renderedIndex),
          playerId: ME.uid,
          answer: myAnswer,
          correctAnswer: currentQ.answer || '',
          isCorrect, elapsedSec, penalty, score,
          type: currentQ.type || 'mcq',
          createdAt: nowTs,
          answeredAt: nowTs,
          submittedAt: nowTs,
          submitted: true
        });

        tr.set(playerDoc, {
          scoreTotal: firebase.firestore.FieldValue.increment(score),
          progressIndex: firebase.firestore.FieldValue.increment(1),
          lastSubmittedOrder: Number(renderedIndex),
          lastElapsedSec: elapsedSec
        }, {merge:true});
      });

      // ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ë¡œì»¬ ì§„í–‰ë„ +1
      myIndexLocal = Math.max(myIndexLocal, renderedIndex + 1);
      myIndex = myIndexLocal;

      // â˜… ë³€ê²½: ë‹¤ìŒìœ¼ë¡œ ë²„íŠ¼ì„ 2ì´ˆê°„ ë¹„í™œì„±í™”í•˜ì—¬ ìµœì†Œ ì²´ë¥˜ì‹œê°„ í™•ë³´
      $('#btnNext').style.display = 'inline-block';
      $('#btnNext').disabled = true;
      setTimeout(()=>{ $('#btnNext').disabled = false; }, 2000); // 2ì´ˆ ëŒ€ê¸°

      if (AUTO_ADVANCE_MS > 0) {
        setTimeout(()=>{ if (!meFinished) renderQuestion(myIndexLocal); }, AUTO_ADVANCE_MS);
      }
    }catch(e){
      console.warn('ì œì¶œ ì‹¤íŒ¨:', e?.message||e);
      if (/already[- ]exists/i.test(String(e?.message||''))) {
        $('#after-msg').textContent = 'ì´ë¯¸ ì œì¶œëœ ë¬¸í•­ì…ë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.';
        $('#after-msg').style.display='block';
        $('#btnNext').style.display = 'inline-block';
        $('#btnNext').disabled = true;
        setTimeout(()=>{ $('#btnNext').disabled = false; }, 2000); // ë™ì¼ ì •ì±… ì ìš©
      } else if (/permission-denied/i.test(String(e?.message||''))) {
        alert('ì œì¶œ ì‹¤íŒ¨: ê¶Œí•œ ì˜¤ë¥˜(ê·œì¹™). Firestore ê·œì¹™ ê²Œì‹œ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        submitted = false;
      } else {
        alert('ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
        submitted = false; // ì¬ì‹œë„ ê°€ëŠ¥
      }
      return;
    }

    $('#btnSubmit').disabled = true;

    // ì ì‹œ í›„ ì„œë²„ ìƒíƒœ ì¬í™•ì¸ â†’ ì™„ë£Œë©´ ì¢…ë£Œí™”ë©´
    setTimeout(async ()=>{
      $('#btnSubmit').disabled=false;
      try{
        const [pSnap, gSnap] = await Promise.all([playerDoc.get(), gameDoc().get()]);
        const px = Math.max(myIndexLocal, Number((pSnap.data()||{}).progressIndex || 0));
        const tq = Number((gSnap.data()||{}).totalQuestions || 0);
        if (tq > 0 && px >= tq) {
          await playerDoc.set({ finished:true }, {merge:true});
          meFinished = true;
          show('#view-end'); stopTimer(); return;
        }
      }catch(_){}
    }, 600);
  }
</script>
</body>
</html>
