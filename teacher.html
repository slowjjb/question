<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>교사 화면</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --line:#334155; --brand:#1d4ed8; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;margin:0;background:var(--bg);color:#fff}
    header{background:var(--brand);padding:12px 16px;display:flex;align-items:center;gap:10px}
    .pill{display:inline-block;background:#172554;border:1px solid #334155;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    button{padding:10px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .primary{background:var(--ok);color:#052814}
    .ghost{background:#374151;color:#fff}
    .warn{background:var(--warn);color:#1f1300}
    .danger{background:var(--danger);color:#2b0b0b}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#0b1220;border:1px solid var(--line);padding:4px 6px;border-radius:8px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    input,select,textarea{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#fff}
    textarea{width:100%;min-height:80px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:14px}
    small{color:var(--muted)}
    .grow{flex:1}
  </style>
</head>
<body>
  <header>
    <div>교사 화면</div>
    <div id="user" class="pill">로그인 확인 중...</div>
  </header>

  <main>
    <!-- 상단 컨트롤 -->
    <div class="row">
      <button id="btnCreate" class="primary">게임 만들기</button>
      <button id="btnStart"  class="warn"   disabled>시작</button>
      <button id="btnPrev"   class="ghost"  disabled>이전 문제</button>
      <button id="btnNext"   class="ghost"  disabled>다음 문제</button>
      <button id="btnReset"  class="ghost"  disabled>초기화(대기)</button>
      <button id="btnEnd"    class="danger" disabled>종료</button>

      <!-- 자동진행 제어 -->
      <button id="btnAuto" class="ghost">자동진행: OFF</button>
      <label class="pill" style="display:flex;align-items:center;gap:6px">
        제한(초)
        <input id="autoSec" type="number" min="5" max="600" step="5" value="75" style="width:90px"/>
      </label>
      <button id="btnSaveAuto" class="ghost">제한 저장</button>

      <button id="btnSignOut" class="ghost">로그아웃</button>
      <a href="./teacher-login.html" class="pill" style="text-decoration:none;">로그인 화면으로</a>
    </div>

    <!-- 게임 상태 표시 -->
    <div class="row card" id="gameInfo" style="display:none;align-items:center;gap:12px;">
      <div>게임 ID: <span id="gid" class="kbd"></span></div>
      <button id="btnCopy" class="ghost">ID 복사</button>
      <div class="pill">학생: /question/join.html</div>
      <div class="pill">상태: <span id="gstatus">-</span></div>
      <div class="pill">현재 문제: <span id="gindex">-</span></div>
      <div class="pill">총 문항: <span id="gtotal">0</span></div>
    </div>

    <!-- 템플릿 관리 / 불러오기 -->
    <section class="card" id="templateBox" style="display:none;">
      <h3 style="margin:0 0 8px;">문제 세트(템플릿) 관리 & 불러오기</h3>
      <div class="row">
        <select id="tplSelect" class="grow"></select>
        <button id="btnTplUse" class="ghost">선택 불러오기</button>
        <button id="btnTplDel" class="danger">선택 삭제</button>
        <span id="tplInfo" class="pill">미리보기: -문항</span>
      </div>
      <div class="row">
        <input id="tplId" class="grow" placeholder="원본 게임 ID (예: KOR-SET-1 혹은 자동 생성 ID)" />
        <input id="tplTitle" class="grow" placeholder="표시 이름 (예: 6학년 국어 세트 1)" />
        <button id="btnTplAdd" class="primary">템플릿 추가(저장)</button>
        <button id="btnTplImport" class="ghost">ID로 불러오기</button>
      </div>
      <small>Tips) 템플릿은 <b>브라우저 로컬 저장소</b>에 저장됩니다. 여러 세트를 만들어 두고 필요할 때 불러오세요.</small>
    </section>

    <!-- 문제 에디터 -->
    <section id="editor" class="card" style="display:none;">
      <h3 style="margin:0 0 8px;">문제 추가</h3>
      <div class="row">
        <label>유형
          <select id="qtype">
            <option value="mcq">객관식</option>
            <option value="short">주관식</option>
          </select>
        </label>
        <label>보기 개수(객관식)
          <select id="qcount">
            <option>2</option><option selected>4</option><option>5</option>
          </select>
        </label>
      </div>
      <div class="row">
        <textarea id="qprompt" placeholder="문제 내용을 입력하세요"></textarea>
      </div>
      <div id="choices" class="row" style="flex-direction:column;width:100%;"></div>
      <div class="row">
        <label>정답
          <input id="qanswer" placeholder="객관식: A/B/C..., 주관식: 정답 문자열" />
        </label>
        <button id="btnAdd" class="primary">문제 추가</button>
      </div>
      <small>객관식 정답 표기는 A/B/C/D/E 중 하나로 입력하면 편합니다.</small>
    </section>

    <!-- 문제 목록 -->
    <section id="list" class="card" style="display:none;">
      <h3 style="margin:0 0 8px;">문제 목록</h3>
      <table>
        <thead><tr><th style="width:60px;">#</th><th>유형</th><th>문제</th><th>정답</th><th style="width:120px;">관리</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <p style="margin-top:16px;"><small>흐름) “게임 만들기” → (필요 시 템플릿 불러오기) → 문제 수정/추가 → 시작/이전/다음/초기화/종료</small></p>
  </main>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="./js/firebase-init.js"></script>

  <script>
    /* ───────── 로그인 가드 ───────── */
    auth.onAuthStateChanged(user => {
      const $u = document.getElementById('user');
      if (!user) { $u.textContent='로그인이 필요합니다'; location.replace('./teacher-login.html'); return; }
      $u.textContent = `로그인: ${user.displayName || user.email}`;
    });

    /* ───────── 유틸 ───────── */
    const $ = s => document.querySelector(s);
    function genId(len=7){ const C='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<len;i++) s+=C[Math.floor(Math.random()*C.length)]; return s; }
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v|0));

    let gameId = localStorage.getItem('q_gameId') || '';
    let unsubGame=null, unsubList=null;

    /* ───────── 템플릿(로컬 저장) ───────── */
    const TPL_KEY = 'q_templates_v1'; // [{id,title}]
    function loadTpls(){ try { return JSON.parse(localStorage.getItem(TPL_KEY)||'[]'); } catch(_) { return []; } }
    function saveTpls(arr){ localStorage.setItem(TPL_KEY, JSON.stringify(arr)); renderTpls(); }
    async function previewTplCount(id){
      try{ const snap = await db.collection('q_games').doc(id).collection('q_questions').get(); return snap.size; }
      catch{ return null; }
    }
    async function renderTpls(){
      const sel = $('#tplSelect'); sel.innerHTML='';
      const tpls = loadTpls();
      if (tpls.length===0) {
        const opt = document.createElement('option'); opt.textContent='(저장된 템플릿 없음)'; opt.value='';
        sel.appendChild(opt); $('#tplInfo').textContent = '미리보기: -문항'; return;
      }
      tpls.forEach(t=>{
        const opt = document.createElement('option'); opt.value = t.id; opt.textContent = `${t.title}  (${t.id})`;
        sel.appendChild(opt);
      });
      sel.onchange = async ()=>{
        const id = sel.value;
        if (!id) { $('#tplInfo').textContent='미리보기: -문항'; return; }
        const n = await previewTplCount(id);
        $('#tplInfo').textContent = `미리보기: ${n ?? '?'}문항`;
      };
      sel.dispatchEvent(new Event('change'));
    }

    async function copyQuestions(srcId, destId) {
      if (!srcId) throw new Error('원본 게임 ID가 없습니다.');
      if (srcId === destId) throw new Error('같은 게임으로는 복사할 수 없습니다.');

      const srcQ = db.collection('q_games').doc(srcId).collection('q_questions').orderBy('order','asc');
      const dstQ = db.collection('q_games').doc(destId).collection('q_questions');

      // 1) 현재 문제들 삭제
      const exist = await dstQ.get();
      if (!exist.empty) {
        let b = db.batch(); let n=0;
        exist.forEach(d=>{ b.delete(dstQ.doc(d.id)); n++; if(n%400===0){ b.commit(); b=db.batch(); } });
        await b.commit();
      }

      // 2) 복사
      const snap = await srcQ.get();
      let b = db.batch(), i=0;
      snap.forEach(doc=>{
        const q=doc.data();
        b.set(dstQ.doc(), {
          type:q.type, prompt:q.prompt, choices:q.choices||null, answer:q.answer,
          order: (typeof q.order==='number'? q.order : i)
        });
        i++; if(i%400===0){ b.commit(); b=db.batch(); }
      });
      await b.commit();

      // 3) 총 문항/상태 초기화
      await db.collection('q_games').doc(destId).set({
        totalQuestions: snap.size, status:'waiting', currentIndex:-1, questionStartAt: null
      }, {merge:true});

      return snap.size;
    }

    /* ───────── 지난 응답/점수 정리 ───────── */
    async function clearResponses(gameId){
      try{
        const col = db.collection('q_games').doc(gameId).collection('q_responses');
        const snap = await col.get();
        if (snap.empty) return;
        let batch = db.batch(), n=0;
        snap.forEach(doc=>{
          batch.delete(col.doc(doc.id));
          n++; if (n%400===0){ batch.commit(); batch = db.batch(); }
        });
        await batch.commit();
      }catch(e){ console.warn('응답 정리 실패(무시):', e?.message||e); }
    }
    async function resetPlayerScores(gameId){ // (선택)
      try{
        const col = db.collection('q_games').doc(gameId).collection('q_players');
        const snap = await col.get();
        if (snap.empty) return;
        let batch = db.batch(), n=0;
        snap.forEach(doc=>{
          batch.set(col.doc(doc.id), { scoreTotal: 0 }, { merge:true });
          n++; if (n%400===0){ batch.commit(); batch = db.batch(); }
        });
        await batch.commit();
      }catch(e){ console.warn('점수 초기화 실패(무시):', e?.message||e); }
    }

    /* ───────── 자동진행(ALL SUBMIT or TIMEOUT) ───────── */
    let autoMode = false;        // 자동진행 ON/OFF
    let limitSec = 75;           // 한 문제 최대 대기 시간(초)
    let autoTick = null;         // 시간 감시 타이머
    let respUnsub = null;        // 현재 문항 응답 리스너
    let playerUnsub = null;      // 플레이어 수 리스너
    let playersCnt = 0;          // 현재 인원
    let autoFired = false;       // 중복 방지

    function killAutoWatchers(){
      autoFired = false;
      if (autoTick){ clearInterval(autoTick); autoTick = null; }
      if (respUnsub){ respUnsub(); respUnsub = null; }
      if (playerUnsub){ playerUnsub(); playerUnsub = null; }
    }

    async function goNextFromAuto(idx){
      const gref = db.collection('q_games').doc(gameId);
      const g = (await gref.get()).data();
      if (!g || g.status!=='running' || g.currentIndex !== idx) return;  // 이미 바뀌었으면 취소

      const total = Number(g.totalQuestions || 0);
      const next  = idx + 1;
      if (next >= total) {
        await gref.set({ status: 'ended' }, {merge:true});
      } else {
        await gref.set({
          currentIndex: next,
          questionStartAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
      }
    }

    function setupAutoForQuestion(g){
      killAutoWatchers();
      if (!autoMode || !gameId || g.status!=='running') return;

      const idx = Number(g.currentIndex || 0);
      autoFired = false;

      // 1) 현재 인원 리스너
      playerUnsub = db.collection('q_games').doc(gameId)
        .collection('q_players')
        .onSnapshot(s=>{ playersCnt = s.size; });

      // 2) 현재 문항 '제출된' 응답만 집계 + 시작 이후 응답만 인정
      respUnsub = db.collection('q_games').doc(gameId)
        .collection('q_responses').where('order','==', idx)
        .onSnapshot(s=>{
          const responded = new Set();

          const startMs = g.questionStartAt && g.questionStartAt.toMillis
            ? g.questionStartAt.toMillis()
            : 0;

          s.forEach(d=>{
            const r = d.data(); if (!r) return;
            // 시작 이후에 생성된 응답만
            const createdMs = r.createdAt && r.createdAt.toMillis ? r.createdAt.toMillis() : 0;
            const isAfterStart = startMs ? (createdMs >= startMs - 500) : true;

            // '제출된' 응답 판단
            const hasSubmittedFlag = r.submitted === true || !!r.answeredAt;
            const hasAnswer = typeof r.answer === 'string' ? r.answer.trim() !== '' : (r.answer != null);

            if (isAfterStart && (hasSubmittedFlag || hasAnswer) && r.playerId) {
              responded.add(r.playerId);
            }
          });

          if (!autoFired && playersCnt>0 && responded.size >= playersCnt) {
            autoFired = true;
            setTimeout(()=> goNextFromAuto(idx), 1200);
          }
        });

      // 3) 시간 초과 감시
      const startAt = g.questionStartAt && g.questionStartAt.toMillis
            ? g.questionStartAt.toMillis() : Date.now();
      autoTick = setInterval(()=>{
        if (autoFired) return;
        const elapsed = (Date.now() - startAt) / 1000;
        if (elapsed >= limitSec) {
          autoFired = true;
          goNextFromAuto(idx);
        }
      }, 500);
    }

    /* ───────── 게임 UI 바인딩 ───────── */
    function ensureUI(){
      if (!gameId) return;
      $('#gid').textContent = gameId;
      $('#gameInfo').style.display='flex';
      $('#templateBox').style.display='block';
      $('#editor').style.display='block';
      $('#list').style.display='block';

      if (unsubGame) unsubGame();
      unsubGame = db.collection('q_games').doc(gameId).onSnapshot(s=>{
        if(!s.exists) return;
        const g=s.data();
        const total = g.totalQuestions || 0;
        const idx   = Number(g.currentIndex ?? -1);

        // 버튼/표시
        $('#gstatus').textContent = g.status;
        $('#gindex').textContent  = idx;
        $('#gtotal').textContent  = total;
        $('#btnStart').disabled = !(g.status==='waiting' && total>0);
        $('#btnPrev').disabled  = !(g.status==='running' && idx>0);
        $('#btnNext').disabled  = !(g.status==='running' && idx < total-1);
        $('#btnEnd').disabled   = !(g.status==='running');
        $('#btnReset').disabled = (g.status==='waiting'); // ended에서도 초기화 가능

        // 자동진행 상태/제한시간 동기화
        autoMode = !!g.auto;
        $('#btnAuto').textContent = '자동진행: ' + (autoMode ? 'ON' : 'OFF');
        limitSec = clamp(g.autoLimitSec ?? limitSec, 5, 600);
        $('#autoSec').value = limitSec;

        setupAutoForQuestion(g);
      });

      if (unsubList) unsubList();
      unsubList = db.collection('q_games').doc(gameId).collection('q_questions')
        .orderBy('order','asc').onSnapshot(sn=>{
          const tbody=$('#tbody'); tbody.innerHTML='';
          sn.forEach(doc=>{
            const q=doc.data();
            const tr=document.createElement('tr');
            tr.innerHTML=`
              <td>${q.order}</td>
              <td>${q.type}</td>
              <td style="max-width:600px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${q.prompt}</td>
              <td>${q.answer}</td>
              <td><button class="ghost" data-del="${doc.id}">삭제</button></td>`;
            tbody.appendChild(tr);
          });
          db.collection('q_games').doc(gameId).set({ totalQuestions: sn.size }, {merge:true});
          tbody.onclick = async (e)=>{
            const id=e.target.getAttribute?.('data-del'); if(!id) return;
            if(!confirm('정말 삭제할까요?')) return;
            await db.collection('q_games').doc(gameId).collection('q_questions').doc(id).delete();
          };
        });
    }

    /* ───────── 상단 버튼 ───────── */
    $('#btnCreate').addEventListener('click', async ()=>{
      const user=auth.currentUser; if(!user) return alert('로그인이 필요합니다');
      gameId = genId(7);
      const gameDoc = {
        title: `퀴즈 - ${new Date().toLocaleString()}`,
        status:'waiting', createdBy:user.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        currentIndex:-1, totalQuestions:0,
        auto:false, autoLimitSec: limitSec, questionStartAt: null
      };
      await db.collection('q_games').doc(gameId).set(gameDoc,{merge:true});
      localStorage.setItem('q_gameId', gameId);
      ensureUI();
      alert('게임이 생성되었습니다. 학생에게 게임 ID를 전달하세요.');
    });

    $('#btnCopy').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(gameId); alert('게임 ID 복사됨'); }
      catch{ alert('복사 실패'); }
    });

    $('#btnSignOut').addEventListener('click', async ()=>{
      await auth.signOut(); location.replace('./teacher-login.html');
    });

    // 시작: 지난 응답 제거 후 시작
    $('#btnStart').addEventListener('click', async ()=>{
      if(!gameId) return;
      const gref = db.collection('q_games').doc(gameId);
      killAutoWatchers();
      await clearResponses(gameId);             // 즉시 자동진행 방지
      // await resetPlayerScores(gameId);       // 필요 시 점수 리셋
      await gref.set({
        status:'running',
        currentIndex:0,
        questionStartAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    });

    $('#btnPrev').addEventListener('click', async ()=>{
      if(!gameId) return;
      const gref = db.collection('q_games').doc(gameId);
      const g=(await gref.get()).data(); const idx=Number(g.currentIndex??0);
      if (idx<=0) return;
      await gref.set({
        currentIndex: idx-1,
        questionStartAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    });

    $('#btnNext').addEventListener('click', async ()=>{
      if(!gameId) return;
      const gref = db.collection('q_games').doc(gameId);
      const g=(await gref.get()).data();
      const total = Number(g.totalQuestions||0);
      const next  = Number(g.currentIndex||0) + 1;
      if (next >= total) {
        await gref.set({ status:'ended' }, {merge:true});
        alert('마지막 문제까지 완료되어 게임을 종료했습니다.');
      } else {
        await gref.set({
          currentIndex: next,
          questionStartAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
      }
    });

    // 초기화(대기): 응답도 함께 비워 안전하게 리셋 (ended에서도 가능)
    $('#btnReset').addEventListener('click', async ()=>{
      if(!confirm('게임을 대기 상태로 초기화할까요? (현재 진행 위치가 초기화됩니다)')) return;
      killAutoWatchers();
      await clearResponses(gameId);
      await db.collection('q_games').doc(gameId).set({
        status:'waiting', currentIndex:-1, questionStartAt: null
      }, {merge:true});
    });

    $('#btnEnd').addEventListener('click', async ()=>{
      killAutoWatchers();
      await db.collection('q_games').doc(gameId).set({ status:'ended' }, {merge:true});
    });

    // 자동진행 토글
    document.getElementById('btnAuto').addEventListener('click', async ()=>{
      autoMode = !autoMode;
      document.getElementById('btnAuto').textContent = '자동진행: ' + (autoMode ? 'ON' : 'OFF');
      if (gameId) await db.collection('q_games').doc(gameId).set({ auto: autoMode }, {merge:true});
      const g = (await db.collection('q_games').doc(gameId).get()).data();
      if (g) setupAutoForQuestion(g);
    });

    // 제한(초) 저장
    document.getElementById('btnSaveAuto').addEventListener('click', async ()=>{
      limitSec = clamp(Number(document.getElementById('autoSec').value||limitSec), 5, 600);
      document.getElementById('autoSec').value = limitSec;
      if (gameId) await db.collection('q_games').doc(gameId).set({ autoLimitSec: limitSec }, {merge:true});
      const g = (await db.collection('q_games').doc(gameId).get()).data();
      if (g) setupAutoForQuestion(g); // 현재 문항에도 즉시 반영
    });

    /* ───────── 문제 에디터 ───────── */
    const $choices = () => [...document.querySelectorAll('[data-chidx]')];
    function renderChoiceInputs(n=4){
      const wrap=document.querySelector('#choices'); wrap.innerHTML='';
      for(let i=0;i<n;i++){
        const L=String.fromCharCode(65+i);
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<label style="width:100%">보기 ${L} <input data-chidx="${i}" style="width:100%" placeholder="보기 내용을 입력하세요"></label>`;
        wrap.appendChild(row);
      }
    }
    renderChoiceInputs(4);
    $('#qcount').addEventListener('change', e=> renderChoiceInputs(Number(e.target.value)));
    $('#qtype').addEventListener('change', e=>{
      const type=e.target.value;
      $('#qcount').disabled = (type!=='mcq');
      $('#choices').style.display = (type==='mcq') ? 'block' : 'none';
    });
    $('#btnAdd').addEventListener('click', async ()=>{
      if(!gameId) return alert('먼저 게임을 만드세요.');
      const type=$('#qtype').value, prompt=$('#qprompt').value.trim(), answer=$('#qanswer').value.trim();
      if(!prompt || !answer) return alert('문제와 정답을 입력하세요.');
      let choices=null;
      if(type==='mcq'){
        choices = $choices().map(i=>i.value.trim()).filter(v=>v!=='');
        if(choices.length<2) return alert('객관식은 최소 2개의 보기 필요');
      }
      const listSnap = await db.collection('q_games').doc(gameId).collection('q_questions').get();
      const order=listSnap.size;
      await db.collection('q_games').doc(gameId).collection('q_questions').add({
        type,prompt,choices,answer,order, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('#qprompt').value=''; $('#qanswer').value=''; $choices().forEach(i=>i.value='');
    });

    /* ───────── 템플릿 UI/행동 ───────── */
    $('#btnTplAdd').addEventListener('click', ()=>{
      const id=$('#tplId').value.trim(); const title=$('#tplTitle').value.trim();
      if(!id || !title){ alert('ID와 표시 이름을 입력하세요.'); return; }
      const list=loadTpls();
      if(list.some(t=>t.id===id)){ alert('이미 저장된 ID입니다.'); return; }
      list.push({id, title}); saveTpls(list);
      $('#tplId').value=''; $('#tplTitle').value='';
    });
    $('#btnTplDel').addEventListener('click', ()=>{
      const id=$('#tplSelect').value; if(!id){ alert('삭제할 템플릿을 선택하세요.'); return; }
      const list=loadTpls().filter(t=>t.id!==id); saveTpls(list);
    });
    $('#btnTplUse').addEventListener('click', async ()=>{
      const id=$('#tplSelect').value; if(!id){ alert('템플릿을 선택하세요.'); return; }
      if(!gameId){ alert('먼저 게임을 만드세요.'); return; }
      if(!confirm('현재 게임의 문제를 모두 지우고 템플릿에서 복사합니다. 계속할까요?')) return;
      try{
        const n = await copyQuestions(id, gameId);
        alert(`복사 완료! (${n}문항)`);
      }catch(e){ alert('복사 실패: '+e.message); console.error(e); }
    });
    $('#btnTplImport').addEventListener('click', async ()=>{
      const id=$('#tplId').value.trim(); if(!id){ alert('원본 게임 ID를 입력하세요.'); return; }
      if(!gameId){ alert('먼저 게임을 만드세요.'); return; }
      if(!confirm('현재 게임의 문제를 모두 지우고 복사합니다. 계속할까요?')) return;
      try{
        const n = await copyQuestions(id, gameId);
        alert(`복사 완료! (${n}문항)`);
      }catch(e){ alert('복사 실패: '+e.message); console.error(e); }
    });
    $('#tplSelect').addEventListener('change', async ()=>{
      const id=$('#tplSelect').value; if(!id){ $('#tplInfo').textContent='미리보기: -문항'; return; }
      const n = await previewTplCount(id); $('#tplInfo').textContent = `미리보기: ${n ?? '?'}문항`;
    });

    // 초기 바인딩
    renderTpls();
    if (gameId) ensureUI();
  </script>
</body>
</html>
