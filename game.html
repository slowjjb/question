<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>교사 화면 (게임 생성)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;margin:0;background:#0f172a;color:#fff}
    header{background:#1d4ed8;padding:12px 16px}
    main{max-width:1000px;margin:24px auto;padding:0 16px}
    .pill{display:inline-block;background:#172554;border:1px solid #334155;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .row{margin:16px 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    button{padding:10px 14px;border-radius:10px;border:0;background:#22c55e;color:#04210f;font-weight:800;cursor:pointer}
    .ghost{background:#374151;color:#fff}
    input{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#fff}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#0b1220;border:1px solid #334155;padding:6px 8px;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <div>교사 화면</div>
    <div id="user" class="pill">로그인 확인 중...</div>
  </header>
  <main>
    <div class="row">
      <button id="btnCreate">게임 만들기</button>
      <button id="btnSignOut" class="ghost">로그아웃</button>
      <a href="./teacher-login.html" class="pill" style="text-decoration:none;margin-left:8px;">로그인 화면으로</a>
    </div>

    <div class="row" id="gameInfo" style="display:none;">
      <div>게임 ID: <span id="gid" class="kbd"></span></div>
      <button id="btnCopy" class="ghost">ID 복사</button>
      <div class="pill">학생 주소: <span class="kbd">/question/join.html</span></div>
    </div>

    <hr style="border-color:#334155">

    <p>✅ 먼저 <b>게임 만들기</b>를 눌러 <code>gameId</code>를 생성하세요.<br>
       학생들은 <code>join.html</code>에서 이 <code>gameId</code>로 입장합니다.<br>
       다음 단계에서 문제 등록/시작 버튼 등을 붙이겠습니다.</p>
  </main>

  <!-- Firebase CDN (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- 공통 초기화 -->
  <script src="./js/firebase-init.js"></script>

  <script>
    // 로그인 체크: 미로그인 시 로그인 페이지로 이동
    auth.onAuthStateChanged(user => {
      const $u = document.getElementById('user');
      if (!user) {
        $u.textContent = '로그인이 필요합니다';
        location.replace('./teacher-login.html');
        return;
      }
      $u.textContent = `로그인: ${user.displayName || user.email}`;
    });

    document.getElementById('btnSignOut').addEventListener('click', async () => {
      await auth.signOut();
      location.replace('./teacher-login.html');
    });

    // 간단한 gameId 생성기 (문자+숫자 6~8자)
    function genId(len=7){
      const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let s=''; for(let i=0;i<len;i++){ s+=chars[Math.floor(Math.random()*chars.length)]; }
      return s;
    }

    document.getElementById('btnCreate').addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) { alert('로그인이 필요합니다.'); return; }

      const gameId = genId(7); // 사람이 말로 전달하기 쉬운 짧은 ID
      const gameDoc = {
        title: `퀴즈 - ${new Date().toLocaleString()}`,
        status: 'waiting',               // waiting → running → ended
        createdBy: user.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        currentIndex: -1,                // 시작 전
        totalQuestions: 0
      };

      try {
        await db.collection('q_games').doc(gameId).set(gameDoc, { merge: true });
        // UI 표시
        document.getElementById('gid').textContent = gameId;
        document.getElementById('gameInfo').style.display = 'flex';
        localStorage.setItem('q_gameId', gameId);
        alert('게임이 생성되었습니다. 게임 ID를 학생들에게 알려주세요.');
      } catch (err) {
        alert('게임 생성에 실패했습니다: ' + err.message);
        console.error(err);
      }
    });

    document.getElementById('btnCopy').addEventListener('click', async () => {
      const gid = document.getElementById('gid').textContent;
      try { await navigator.clipboard.writeText(gid); alert('게임 ID가 복사되었습니다.'); }
      catch { alert('복사 실패. 직접 선택하여 복사하세요.'); }
    });
  </script>
</body>
</html>
